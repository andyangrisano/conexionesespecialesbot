<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TAVIA – Conexiones Especiales</title>
<style>
  :root { --brand:#e11d48; --bg:#fff; --bot:#ffe5e8; --me:#f4f4f5; --text:#0f172a; --muted:#64748b; --radius:12px; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  .bar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f5f9;background:#fff}
  .logo{width:26px;height:26px;object-fit:contain}
  .title{font-weight:700;font-size:15px}
  .subtitle{font-size:12px;color:var(--muted);margin-top:1px}
  .wrap{max-width:720px;margin:0 auto;padding:6px 10px 64px}
  #log{display:flex;flex-direction:column;gap:8px}
  .row{display:flex}
  .bubble{padding:8px 10px;border-radius:var(--radius);max-width:90%;line-height:1.32;font-size:14px;word-wrap:break-word;white-space:pre-wrap}
  .me{justify-content:flex-end}.me .bubble{background:var(--me);border-bottom-right-radius:6px}
  .bot{justify-content:flex-start}.bot .bubble{background:var(--bot);border-bottom-left-radius:6px}
  .time{display:none}
  form{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e7eb;padding:8px}
  .inner{max-width:720px;margin:0 auto;display:flex;gap:8px}
  input{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;outline:none;font-size:14px}
  button{padding:0 14px;border-radius:10px;border:none;background:var(--brand);color:#fff;font-weight:600;height:38px}
</style>

<!-- Top bar -->
<div class="bar">
  <img class="logo" src="/tavia-logo.png" alt="TAVIA" onerror="this.style.display='none'">
  <div>
    <div class="title">TAVIA</div>
    <div class="subtitle">Conexiones Especiales</div>
  </div>
</div>

<!-- Chat area -->
<div class="wrap">
  <div id="header" class="subtitle" style="margin-bottom:6px">Bienvenido a TAVIA</div>
  <div id="log"></div>
</div>

<!-- Input -->
<form id="f" autocomplete="off">
  <div class="inner">
    <input id="inp" placeholder="Escribe aquí…" />
    <button id="sendBtn">Enviar</button>
  </div>
</form>

<script>
  // ===== Params desde Glide =====
  const params = new URLSearchParams(location.search);
  const userId = params.get('userId') || 'anon';
  const name = (params.get('name') || '').trim();
  const role = (params.get('role') || '').toLowerCase(); // 'athlete' | 'volunteer'
  const intellectualParam = (params.get('intellectual') || '').toLowerCase();
  const physicalParam = (params.get('physical') || '').toLowerCase();
  const sport = (params.get('sport') || '').trim();

  // Normalizamos booleans: "true", "1", "sí", "si", "x" -> true
  function toBool(v){
    return ['true','1','si','sí','x','checked','on'].includes(String(v).trim().toLowerCase());
  }
  const hasIntellectual = toBool(intellectualParam);
  const hasPhysical = toBool(physicalParam);

  // ===== Reglas por perfil/discapacidad/deporte =====
  const baseRules = `Eres TAVIA, el asistente de Conexiones Especiales.
- Sé amable, claro y breve.
- Evita consejos médicos/legales; sugiere consultar a un adulto responsable.`;

  const roleRules = role === 'atleta'
    ? `Hablas con un atleta. Usa lenguaje simple, positivo y concreto. Propón pasos cortos y celebra avances.`
    : `Hablas con un voluntario. Da sugerencias prácticas y respetuosas para acompañar y motivar; ofrece ideas de interacción.`;

  const intellectualRules = hasIntellectual ? `Discapacidad intelectual: usa palabras simples, 1 instrucción por vez, ejemplos del día a día. Repite lo esencial y refuerza logros.` : ``;
  const physicalRules = hasPhysical ? `Discapacidad física: ofrece alternativas accesibles (adaptar tiempos/espacios), sugiere actividades seguras y celebra el esfuerzo, no solo el resultado.` : ``;

  const sportRules = sport
    ? `Deporte del usuario: ${sport}. Relaciona ejemplos y motivaciones con este deporte. Propón ideas de conversación/actividad vinculadas a ${sport}.`
    : ``;

  const systemPrompt =
`${baseRules}
${roleRules}
${intellectualRules ? '- ' + intellectualRules : ''}
${physicalRules ? '- ' + physicalRules : ''}
${sportRules ? '- ' + sportRules : ''}`.trim();

  // ===== UI helpers =====
  const log = document.getElementById('log');
  const f = document.getElementById('f');
  const inp = document.getElementById('inp');
  const sendBtn = document.getElementById('sendBtn');

  function addRow(text, who){
    const row = document.createElement('div');
    row.className = 'row ' + (who === 'me' ? 'me' : 'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    row.appendChild(bubble);
    log.appendChild(row);
    row.scrollIntoView({behavior:'smooth', block:'end'});
  }

  function setDisabled(v){ inp.disabled = v; sendBtn.disabled = v; }

  // ===== Conversación =====
  const messages = [{ role:'system', content: systemPrompt }];

  // Saludo inicial (sin mostrar role)
  addRow(`¡Hola${name ? ', ' + name : ''}! Soy TAVIA. ¿En qué puedo ayudarte hoy?`, 'bot');

  async function ask(){
    setDisabled(true);

    // Guardamos solo últimas ~10 interacciones para ahorrar tokens
    const MAX_MESSAGES = 21; // 1 system + 10 pares
    if (messages.length > MAX_MESSAGES){
      const sys = messages[0];
      const tail = messages.slice(- (MAX_MESSAGES - 1));
      messages.length = 0; messages.push(sys, ...tail);
    }

    try{
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ messages, user: { userId, name, role, hasIntellectual, hasPhysical, sport } })
      });
      const data = await res.json();
      const reply = data?.reply || (data?.error ? `Error: ${data.error}` : 'Sin respuesta.');
      addRow(reply, 'bot');
      messages.push({ role:'assistant', content: reply });
    }catch(e){
      addRow('Error de conexión. Intenta de nuevo.', 'bot');
    }finally{
      setDisabled(false); inp.focus();
    }
  }

  f.addEventListener('submit', (e)=>{
    e.preventDefault();
    const q = (inp.value || '').trim();
    if (!q) return;
    inp.value = '';
    addRow(q, 'me');
    messages.push({ role:'user', content:q });
    ask();
  });
</script>

