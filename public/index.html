<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TAVIA – Conexiones Especiales</title>
<style>
  :root{
    --brand:#e11d48; --bg:#fff; --bot:#ffe5e8; --me:#f4f4f5; --text:#0f172a; --muted:#64748b;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--text)}

  /* Top bar */
  .bar{
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; gap:10px;
    padding:8px 12px; border-bottom:1px solid #f1f5f9; background:#fff;
  }
  .logo{width:26px;height:26px;object-fit:contain}
  .title{font-weight:700;font-size:15px}
  .subtitle{font-size:12px;color:var(--muted);margin-top:1px}

  /* Chat area */
  .wrap{max-width:720px;margin:0 auto; padding:6px 10px 64px}
  #log{display:flex;flex-direction:column;gap:8px}
  .row{display:flex}
  .bubble{padding:8px 10px;border-radius:var(--radius);max-width:90%;line-height:1.32;font-size:14px;white-space:pre-wrap;word-wrap:break-word}
  .me{justify-content:flex-end}.me .bubble{background:var(--me);border-bottom-right-radius:6px}
  .bot{justify-content:flex-start}.bot .bubble{background:var(--bot);border-bottom-left-radius:6px}

  /* Typing indicator */
  .typing{display:inline-block; min-width:24px}
  .dot{display:inline-block; width:6px; height:6px; margin:0 1px; border-radius:50%; background:#9ca3af; animation: blink 1.2s infinite}
  .dot:nth-child(2){animation-delay:0.2s}
  .dot:nth-child(3){animation-delay:0.4s}
  @keyframes blink { 0%,80%,100%{opacity:.2} 40%{opacity:1} }

  /* Composer (input) fixed bottom */
  form{
    position:fixed; left:0; right:0; bottom:0; background:#fff;
    border-top:1px solid #e5e7eb; padding:8px;
  }
  .inner{max-width:720px;margin:0 auto;display:flex;gap:8px}
  input{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;outline:none;font-size:14px}
  button{padding:0 14px;border-radius:10px;border:none;background:var(--brand);color:#fff;font-weight:600;height:38px}
</style>

<!-- Top bar -->
<div class="bar">
  <img class="logo" src="/tavia-logo.png" alt="TAVIA" onerror="this.style.display='none'">
  <div>
    <div class="title">TAVIA</div>
    <div class="subtitle">Conexiones Especiales</div>
  </div>
</div>

<!-- Chat stream -->
<div class="wrap">
  <div id="log"></div>
</div>

<!-- Input at bottom -->
<form id="f" autocomplete="off">
  <div class="inner">
    <input id="inp" placeholder="Escribe aquí…" />
    <button id="sendBtn">Enviar</button>
  </div>
</form>

<script>
  // ========= Lectura de parámetros desde Glide =========
  const qs = new URLSearchParams(location.search);
  function getParam(...keys){
    for(const k of keys){
      const v = qs.get(k);
      if (v !== null && v !== '') return v;
    }
    return '';
  }

  // Datos del usuario que chatea
  const firstName = (getParam('firstName','First Name','name','Name') || '').trim();
  const lastName  = (getParam('lastName','Last Name','surname','Surname') || '').trim();
  const roleRaw   = (getParam('role','Role') || '').trim().toLowerCase();
  const hobbies   = (getParam('hobbies','Hobbies') || '').trim();
  const intellectual = (getParam('intellectual','Disability/Intellectual','Disability%2FIntellectual') || '').trim();
  const physical     = (getParam('physical','Disability/Physical','Disability%2FPhysical') || '').trim();
  const sport        = (getParam('sport','deporte','Sport') || '').trim();
  const rowId        = (getParam('rowId','Row ID','RowID','Row Id') || '').trim();

  const role = roleRaw === 'athlete' ? 'atleta'
             : roleRaw === 'volunteer' ? 'voluntario'
             : roleRaw;

  // ======== Info PRIVADA del atleta asignado (solo si el usuario es voluntario) ========
  // Espera recibir estos parámetros desde Glide cuando haya una pareja activa.
  const aName        = (getParam('athleteName','Athlete Name','athlete_first','athleteFirst','aName') || '').trim();
  const aHobbies     = (getParam('athleteHobbies','Athlete Hobbies','aHobbies') || '').trim();
  const aIntellectual= (getParam('athleteIntellectual','Athlete Intellectual','aIntellectual') || '').trim();
  const aPhysical    = (getParam('athletePhysical','Athlete Physical','aPhysical') || '').trim();
  const aSport       = (getParam('athleteSport','Athlete Sport','aSport') || '').trim();

  const hasAthleteCtx = role === 'voluntario' && (aName || aHobbies || aIntellectual || aPhysical || aSport);

  // ========= Prompt del sistema =========
  const baseRules =
`Eres TAVIA, el asistente virtual de Conexiones Especiales.
- Sé amable, claro y breve, con un tono positivo.
- Evita consejos médicos o legales; sugiere consultar a un adulto responsable cuando aplique.`;

  const roleRules = role === 'atleta'
    ? `Estás conversando con un atleta. Usa lenguaje sencillo, positivo y concreto.`
    : role === 'voluntario'
      ? `Estás conversando con un voluntario. Ofrece sugerencias prácticas y respetuosas para acompañar y motivar.`
      : `Si no conoces el rol, pide amablemente que lo indiquen (atleta o voluntario).`;

  // Reglas de privacidad cuando hay información del atleta (NO revelar)
  const privacyRules = hasAthleteCtx ? `
INSTRUCCIONES DE PRIVACIDAD (OBLIGATORIAS):
- Tienes acceso a información PRIVADA del atleta emparejado con el voluntario para adaptar mejor tus sugerencias.
- NUNCA reveles, menciones ni insinúes diagnósticos, discapacidades o datos de salud del atleta.
- Si el voluntario pregunta directamente por diagnósticos o condiciones, responde: 
  "No puedo compartir información médica o diagnósticos por privacidad. Si tienes inquietudes, hablemos de estrategias generales o consulta al coordinador/encargado."
- Usa la información privada solo para ajustar recomendaciones de forma genérica (por ejemplo, sugerencias de comunicación, organización o seguridad), sin nombrar la condición ni detalles clínicos.` : ``;

  // Contexto visible del usuario que escribe (esto NO expone info privada del atleta)
  const hobbiesRule = hobbies ? `Hobbies del usuario: ${hobbies}.` : ``;
  const intellectualRule = intellectual ? `Discapacidad intelectual (del usuario): ${intellectual}.` : ``;
  const physicalRule = physical ? `Discapacidad física (del usuario): ${physical}.` : ``;
  const sportRule = sport ? `Deporte del usuario: ${sport}.` : ``;

  const userContext =
`Contexto del usuario que escribe:
- ID: ${rowId || 'N/D'}
- Nombre: ${(firstName || 'N/D')} ${(lastName || '').trim()}
- Rol: ${role || 'N/D'}
- Hobbies: ${hobbies || 'N/D'}
- Discapacidad intelectual (usuario): ${intellectual || 'N/D'}
- Discapacidad física (usuario): ${physical || 'N/D'}
- Deporte (usuario): ${sport || 'N/D'}`;

  // Contexto PRIVADO del atleta (solo para el modelo; JAMÁS se muestra/expone)
  const privateAthleteContext = hasAthleteCtx ? `
[PRIVADO PARA RAZONAMIENTO, NO DIVULGAR]
Atleta asignado a este voluntario:
- Nombre: ${aName || 'N/D'}
- Hobbies: ${aHobbies || 'N/D'}
- Deporte: ${aSport || 'N/D'}
- Discapacidad intelectual (si existe): ${aIntellectual || 'N/D'}
- Discapacidad física (si existe): ${aPhysical || 'N/D'}
Usa estos datos para adaptar sugerencias sin mencionar ninguna discapacidad ni detalle médico.` : ``;

  const systemPrompt = [
    baseRules,
    roleRules,
    privacyRules,
    hobbiesRule && ('- ' + hobbiesRule),
    intellectualRule && ('- ' + intellectualRule),
    physicalRule && ('- ' + physicalRule),
    sportRule && ('- ' + sportRule),
    '',
    userContext,
    privateAthleteContext
  ].filter(Boolean).join('\n');

  // ========= UI helpers =========
  const log = document.getElementById('log');
  const f = document.getElementById('f');
  const inp = document.getElementById('inp');
  const sendBtn = document.getElementById('sendBtn');

  function addRow(text, who){
    const row = document.createElement('div');
    row.className = 'row ' + (who === 'me' ? 'me' : 'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    row.appendChild(bubble);
    log.appendChild(row);
    row.scrollIntoView({behavior:'smooth', block:'end'});
    return row;
  }

  let typingRow = null;
  function showTyping(){
    typingRow = document.createElement('div');
    typingRow.className = 'row bot';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    const span = document.createElement('span');
    span.className = 'typing';
    span.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    bubble.appendChild(span);
    typingRow.appendChild(bubble);
    log.appendChild(typingRow);
    typingRow.scrollIntoView({behavior:'smooth', block:'end'});
  }
  function hideTyping(){
    if (typingRow && typingRow.parentNode) typingRow.parentNode.removeChild(typingRow);
    typingRow = null;
  }

  function setDisabled(v){ inp.disabled = v; sendBtn.disabled = v; }

  // ========= Conversación =========
  const messages = [{ role:'system', content: systemPrompt }];

  const saludo = `¡Hola${firstName ? ', ' + firstName : ''}! Soy TAVIA, tu amigo virtual de inteligencia artificial. ¿Cómo puedo ayudarte hoy?`;
  addRow(saludo, 'bot');

  function trimHistory(){
    const MAX_MESSAGES = 21;
    if (messages.length > MAX_MESSAGES){
      const sys = messages[0];
      const tail = messages.slice(- (MAX_MESSAGES - 1));
      messages.length = 0; messages.push(sys, ...tail);
    }
  }

  async function ask(){
    setDisabled(true);
    trimHistory();
    showTyping();

    try{
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          messages,
          // Mandamos metadatos mínimos; la info privada ya va en el systemPrompt
          user: { rowId, firstName, lastName, role, hobbies, sport, hasAthleteCtx }
        })
      });
      const data = await res.json();
      hideTyping();
      const reply = data?.reply || (data?.error ? `Error: ${data.error}` : 'Sin respuesta.');
      addRow(reply, 'bot');
      messages.push({ role:'assistant', content: reply });
    }catch(e){
      hideTyping();
      addRow('Error de conexión. Intenta de nuevo.', 'bot');
    }finally{
      setDisabled(false); inp.focus();
    }
  }

  f.addEventListener('submit', (e)=>{
    e.preventDefault();
    const q = (inp.value || '').trim();
    if (!q) return;
    inp.value = '';
    addRow(q, 'me');
    messages.push({ role:'user', content:q });
    ask();
  });
</script>
