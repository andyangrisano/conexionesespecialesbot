<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TAVIA – Conexiones Especiales</title>
<style>
  :root{
    --brand:#e11d48; --bg:#fff; --bot:#ffe5e8; --me:#f4f4f5; --text:#0f172a; --muted:#64748b;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  /* Top bar */
  .bar{
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; gap:10px;
    padding:8px 12px; border-bottom:1px solid #f1f5f9; background:#fff;
  }
  .logo{width:26px;height:26px;object-fit:contain}
  .title{font-weight:700;font-size:15px}
  .subtitle{font-size:12px;color:var(--muted);margin-top:1px}
  /* Chat area */
  .wrap{max-width:720px;margin:0 auto; padding:6px 10px 64px}
  #log{display:flex;flex-direction:column;gap:8px}
  .row{display:flex}
  .bubble{padding:8px 10px;border-radius:var(--radius);max-width:90%;line-height:1.32;font-size:14px;white-space:pre-wrap;word-wrap:break-word}
  .me{justify-content:flex-end}.me .bubble{background:var(--me);border-bottom-right-radius:6px}
  .bot{justify-content:flex-start}.bot .bubble{background:var(--bot);border-bottom-left-radius:6px}
  /* Composer (input) fixed bottom */
  form{
    position:fixed; left:0; right:0; bottom:0; background:#fff;
    border-top:1px solid #e5e7eb; padding:8px;
  }
  .inner{max-width:720px;margin:0 auto;display:flex;gap:8px}
  input{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;outline:none;font-size:14px}
  button{padding:0 14px;border-radius:10px;border:none;background:var(--brand);color:#fff;font-weight:600;height:38px}
</style>

<!-- Fixed header -->
<div class="bar">
  <img class="logo" src="/tavia-logo.png" alt="TAVIA" onerror="this.style.display='none'">
  <div>
    <div class="title">TAVIA</div>
    <div class="subtitle">Conexiones Especiales</div>
  </div>
</div>

<!-- Chat stream -->
<div class="wrap">
  <div id="log"></div>
</div>

<!-- Input at bottom -->
<form id="f" autocomplete="off">
  <div class="inner">
    <input id="inp" placeholder="Escribe aquí…" />
    <button id="sendBtn">Enviar</button>
  </div>
</form>

<script>
  // ====== Parámetros desde Glide ======
  const params = new URLSearchParams(location.search);
  const name = (params.get('Name') || '').trim();
  const role = (params.get('Role') || '').trim().toLowerCase(); // "atleta" | "voluntario"
  const userId = (params.get('Row ID') || '').trim();

  const intellectualDesc = (params.get('Disability/Intellectual') || '').trim();
  const physicalDesc     = (params.get('Disability/Physical') || '').trim();
  const sport             = (params.get('deporte') || '').trim();

  // ====== Reglas por perfil/discapacidad/deporte ======
  const baseRules =
`Eres TAVIA, el asistente de Conexiones Especiales.
- Sé amable, claro y breve.
- Evita consejos médicos o legales; sugiere consultar a un adulto responsable cuando aplique.`;

  const roleRules = role === 'atleta'
    ? `Hablas con un atleta. Usa lenguaje sencillo, positivo y concreto. Propón pasos cortos y celebra avances.`
    : `Hablas con un voluntario. Ofrece sugerencias prácticas y respetuosas para acompañar y motivar.`;

  const intellectualRules = intellectualDesc
    ? `Discapacidad intelectual específica: ${intellectualDesc}. Ajusta tu comunicación considerando esta condición.`
    : ``;

  const physicalRules = physicalDesc
    ? `Discapacidad física específica: ${physicalDesc}. Considera adaptaciones necesarias y fomenta la inclusión.`
    : ``;

  const sportRules = sport
    ? `Deporte del usuario: ${sport}. Relaciona ejemplos y motivaciones con este deporte.`
    : ``;

  // Contexto del usuario que se envía al modelo en cada request
  const userContext =
`Contexto del usuario:
- ID: ${userId || 'desconocido'}
- Nombre: ${name || 'N/D'}
- Rol: ${role || 'N/D'}
- Discapacidad intelectual: ${intellectualDesc || 'N/D'}
- Discapacidad física: ${physicalDesc || 'N/D'}
- Deporte: ${sport || 'N/D'}`;

  const systemPrompt =
`${baseRules}
${roleRules}
${intellectualRules ? '- ' + intellectualRules : ''}
${physicalRules ? '- ' + physicalRules : ''}
${sportRules ? '- ' + sportRules : ''}

${userContext}`.trim();

  // ====== UI helpers ======
  const log = document.getElementById('log');
  const f = document.getElementById('f');
  const inp = document.getElementById('inp');
  const sendBtn = document.getElementById('sendBtn');

  function addRow(text, who){
    const row = document.createElement('div');
    row.className = 'row ' + (who === 'me' ? 'me' : 'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    row.appendChild(bubble);
    log.appendChild(row);
    row.scrollIntoView({behavior:'smooth', block:'end'});
  }
  function setDisabled(v){ inp.disabled = v; sendBtn.disabled = v; }

  const messages = [{ role:'system', content: systemPrompt }];

  // Saludo inicial
  addRow(`¡Hola${name ? ', ' + name : ''}! Soy TAVIA. ¿En qué puedo ayudarte hoy?`, 'bot');

  function trimHistory(){
    const MAX_MESSAGES = 21; // 1 system + 10 pares
    if (messages.length > MAX_MESSAGES){
      const sys = messages[0];
      const tail = messages.slice(- (MAX_MESSAGES - 1));
      messages.length = 0; messages.push(sys, ...tail);
    }
  }

  async function ask(){
    setDisabled(true);
    trimHistory();

    try{
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          messages,
          user: { userId, name, role, intellectualDesc, physicalDesc, sport }
        })
      });
      const data = await res.json();
      const reply = data?.reply || (data?.error ? `Error: ${data.error}` : 'Sin respuesta.');
      addRow(reply, 'bot');
      messages.push({ role:'assistant', content: reply });
    }catch(e){
      addRow('Error de conexión. Intenta de nuevo.', 'bot');
    }finally{
      setDisabled(false); inp.focus();
    }
  }

  f.addEventListener('submit', (e)=>{
    e.preventDefault();
    const q = (inp.value || '').trim();
    if (!q) return;
    inp.value = '';
    addRow(q, 'me');
    messages.push({ role:'user', content:q });
    ask();
  });
</script>


