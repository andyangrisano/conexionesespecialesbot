<script>
  // =======================
  // LECTURA DE PARÁMETROS
  // =======================
  const params = new URLSearchParams(location.search);

  // Devuelve el primer valor no vacío entre posibles claves
  function getParam(...keys) {
    for (const k of keys) {
      const v = params.get(k);
      if (v !== null && v !== '') return v; // URLSearchParams ya decodifica
    }
    return '';
  }

  // Claves aceptadas (seguras y "raras" de Glide)
  const name            = (getParam('name', 'Name') || '').trim();
  const roleRaw         = (getParam('role', 'Role') || '').trim().toLowerCase();
  const userId          = (getParam('rowId', 'RowId', 'RowID', 'Row ID', 'Row Id') || '').trim();
  const intellectualDesc= (getParam('intellectual','Disability/Intellectual','Disability%2FIntellectual') || '').trim();
  const physicalDesc    = (getParam('physical','Disability/Physical','Disability%2FPhysical') || '').trim();
  const sport           = (getParam('sport', 'deporte') || '').trim();

  // Normaliza rol a español
  const role = roleRaw === 'athlete' ? 'atleta'
             : roleRaw === 'volunteer' ? 'voluntario'
             : roleRaw;

  // =======================
  // PROMPT DEL SISTEMA
  // =======================
  const baseRules =
`Eres TAVIA, el asistente de Conexiones Especiales.
- Sé amable, claro y breve.
- Evita consejos médicos o legales; sugiere consultar a un adulto responsable cuando aplique.`;

  const roleRules = role === 'atleta'
    ? `Hablas con un atleta. Usa lenguaje sencillo, positivo y concreto. Propón pasos cortos y celebra avances.`
    : role === 'voluntario'
      ? `Hablas con un voluntario. Ofrece sugerencias prácticas y respetuosas para acompañar y motivar.`
      : `Si no conoces el rol, pide amablemente que lo indiquen (atleta o voluntario).`;

  const intellectualRules = intellectualDesc
    ? `Discapacidad intelectual específica: ${intellectualDesc}. Ajusta la comunicación: palabras simples, 1 instrucción por vez, ejemplos del día a día y repite lo esencial.`
    : ``;

  const physicalRules = physicalDesc
    ? `Discapacidad física específica: ${physicalDesc}. Considera adaptaciones necesarias (tiempos/espacios), sugiere actividades seguras y celebra el esfuerzo.`
    : ``;

  const sportRules = sport
    ? `Deporte del usuario: ${sport}. Relaciona ejemplos, motivaciones e ideas de conversación/actividad con ${sport}.`
    : ``;

  const userContext =
`Contexto del usuario:
- ID: ${userId || 'desconocido'}
- Nombre: ${name || 'N/D'}
- Rol: ${role || 'N/D'}
- Discapacidad intelectual: ${intellectualDesc || 'N/D'}
- Discapacidad física: ${physicalDesc || 'N/D'}
- Deporte: ${sport || 'N/D'}`;

  const systemPrompt =
`${baseRules}
${roleRules}
${intellectualRules ? '- ' + intellectualRules : ''}
${physicalRules ? '- ' + physicalRules : ''}
${sportRules ? '- ' + sportRules : ''}

${userContext}`.trim();

  // =======================
  // UI BÁSICA
  // =======================
  const log = document.getElementById('log');
  const f = document.getElementById('f');
  const inp = document.getElementById('inp');
  const sendBtn = document.getElementById('sendBtn');

  function addRow(text, who){
    const row = document.createElement('div');
    row.className = 'row ' + (who === 'me' ? 'me' : 'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;
    row.appendChild(bubble);
    log.appendChild(row);
    row.scrollIntoView({behavior:'smooth', block:'end'});
  }

  function setDisabled(v){ if(inp) inp.disabled = v; if(sendBtn) sendBtn.disabled = v; }

  // =======================
  // CONVERSACIÓN
  // =======================
  const messages = [{ role:'system', content: systemPrompt }];

  // Saludo inicial
  addRow(`¡Hola${name ? ', ' + name : ''}! Soy TAVIA. ¿En qué puedo ayudarte hoy?`, 'bot');

  // Mantener histórico corto para ahorrar tokens
  function trimHistory(){
    const MAX_MESSAGES = 21; // 1 system + 10 pares
    if (messages.length > MAX_MESSAGES){
      const sys = messages[0];
      const tail = messages.slice(- (MAX_MESSAGES - 1));
      messages.length = 0; messages.push(sys, ...tail);
    }
  }

  async function ask(){
    setDisabled(true);
    trimHistory();

    try{
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          messages,
          // Metadatos para tu backend/analítica si luego los usas
          user: { userId, name, role, intellectualDesc, physicalDesc, sport }
        })
      });
      const data = await res.json();
      const reply = data?.reply || (data?.error ? `Error: ${data.error}` : 'Sin respuesta.');
      addRow(reply, 'bot');
      messages.push({ role:'assistant', content: reply });
    }catch(e){
      addRow('Error de conexión. Intenta de nuevo.', 'bot');
    }finally{
      setDisabled(false); if(inp) inp.focus();
    }
  }

  // Envío del mensaje
  if (f) {
    f.addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = (inp?.value || '').trim();
      if (!q) return;
      if (inp) inp.value = '';
      addRow(q, 'me');
      messages.push({ role:'user', content:q });
      ask();
    });
  }

  // =======================
  // DEBUG OPCIONAL (?debug=1)
  // =======================
  if ((params.get('debug') || '') === '1') {
    addRow(
`[DEBUG]
name=${name}
role=${role}
rowId=${userId}
intellectual=${intellectualDesc}
physical=${physicalDesc}
sport=${sport}`, 'bot');
  }
</script>



