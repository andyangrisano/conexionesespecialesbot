<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TAVIA – Conexiones Especiales</title>
<style>
  :root {
    --brand: #e11d48;        /* CE red */
    --bg: #ffffff;
    --bot: #ffe5e8;          /* light brand tint */
    --me:  #f4f4f5;          /* neutral gray */
    --text: #0f172a;
    --muted: #64748b;
    --radius: 14px;
  }
  * { box-sizing: border-box }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:var(--bg); color:var(--text); }
  .bar {
    position: sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:12px;
    padding:12px 16px; border-bottom:1px solid #f1f5f9; background:#fff;
  }
  .logo { width:32px; height:32px; object-fit:contain }
  .title { font-weight:700; letter-spacing:.2px }
  .subtitle { font-size:12px; color:var(--muted); margin-top:2px }
  .wrap { max-width: 720px; margin: 0 auto; padding: 12px 16px 88px }
  #log { display:flex; flex-direction:column; gap:10px; }
  .row { display:flex; }
  .bubble {
    padding: 10px 12px; border-radius: var(--radius);
    max-width: 85%; line-height:1.35; word-wrap:break-word; white-space:pre-wrap;
    box-shadow: 0 1px 0 rgba(0,0,0,.04);
  }
  .me { justify-content:flex-end; }
  .me .bubble { background: var(--me); border-bottom-right-radius: 6px; }
  .bot { justify-content:flex-start; }
  .bot .bubble { background: var(--bot); border-bottom-left-radius: 6px; }
  .time { font-size: 11px; color: var(--muted); margin-top: 2px; }
  form {
    position: fixed; left:0; right:0; bottom:0; background:#fff;
    border-top:1px solid #e5e7eb; padding: 10px 12px; display:flex; gap:8px;
  }
  .inner { max-width: 720px; margin: 0 auto; width:100%; display:flex; gap:8px }
  input {
    flex:1; padding:12px; border:1px solid #e5e7eb; border-radius: 12px; outline:none;
  }
  button {
    padding: 0 16px; border-radius: 12px; border:none; background: var(--brand); color:#fff; font-weight:600;
  }
  .typing { font-size:12px; color:var(--muted); margin-left:6px }
</style>

<!-- Top bar -->
<div class="bar">
  <img class="logo" src="/tavia-logo.png" alt="TAVIA logo" onerror="this.style.display='none'">
  <div>
    <div class="title">TAVIA</div>
    <div class="subtitle">Conexiones Especiales</div>
  </div>
</div>

<!-- Chat area -->
<div class="wrap">
  <div id="header" class="subtitle" style="margin-bottom:8px"></div>
  <div id="log"></div>
</div>

<!-- Input -->
<form id="f" autocomplete="off">
  <div class="inner">
    <input id="inp" placeholder="Escribe aquí…" />
    <button id="sendBtn">Enviar</button>
  </div>
</form>

<script>
  // URL params from Glide
  const params = new URLSearchParams(location.search);
  const name = params.get('name') || 'Usuario';
  const role = params.get('role') || 'volunteer';
  const userId = params.get('userId') || 'anon';

  document.getElementById('header').textContent = `Bienvenido a TAVIA • ${name} (${role})`;

  // System prompt tuned for CE
  const base = `Eres TAVIA, el asistente de Conexiones Especiales:
- Sé amable, claro y breve.
- Si el usuario es "athlete", usa lenguaje simple, positivo y concreto.
- Evita consejos médicos/legales; sugiere consultar a un adulto responsable.`;

  const messages = [{ role:'system', content: base }];

  const log = document.getElementById('log');
  const f = document.getElementById('f');
  const inp = document.getElementById('inp');
  const sendBtn = document.getElementById('sendBtn');

  function time() {
    const d = new Date();
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  function addRow(text, who) {
    const row = document.createElement('div');
    row.className = 'row ' + (who === 'me' ? 'me' : 'bot');

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;

    const t = document.createElement('div');
    t.className = 'time';
    t.textContent = time();

    const box = document.createElement('div');
    box.appendChild(bubble);
    box.appendChild(t);

    row.appendChild(box);
    log.appendChild(row);
    row.scrollIntoView({behavior:'smooth', block:'end'});
  }

  function setDisabled(v) { inp.disabled = v; sendBtn.disabled = v; }

  async function ask(q) {
    setDisabled(true);
    // keep last ~10 exchanges to save tokens
    const MAX_MESSAGES = 21;
    if (messages.length > MAX_MESSAGES) {
      const sys = messages[0];
      const tail = messages.slice(- (MAX_MESSAGES - 1));
      messages.length = 0; messages.push(sys, ...tail);
    }

    try {
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ messages, user: { userId, name, role } })
      });
      const data = await res.json();
      const reply = data?.reply || (data?.error ? `Error: ${data.error}` : 'Sin respuesta.');
      addRow(reply, 'bot');
      messages.push({ role:'assistant', content: reply });
    } catch {
      addRow('Error de conexión. Intenta de nuevo.', 'bot');
    } finally {
      setDisabled(false);
      inp.focus();
    }
  }

  // Welcome message from TAVIA
  addRow(`¡Hola, ${name}! Soy TAVIA. ¿En qué puedo ayudarte hoy?`, 'bot');

  f.addEventListener('submit', (e) => {
    e.preventDefault();
    const q = (inp.value || '').trim();
    if (!q) return;
    inp.value = '';
    addRow(q, 'me');
    messages.push({ role:'user', content:q });
    ask(q);
  });
</script>

